<!DOCTYPE html>
<html lang="en">
<head>
    <title>Bing V9 Side-by-Side</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../dist/maplibre-gl.css" />
    <style>
        body { margin: 0; padding: 0; }
        html, body, .map { height: 100%; }
        .map { width: 50%; }
        .map-pair { display: flex; height: 100%; width: 100%; flex-direction: row; }
        .orange { color: orange; }
        #checkboxes {
            position: absolute;
            top:0;
            right:0;
            padding:10px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
    </style>
</head>

<body>
<div class="map-pair">
    <div class="map" id="mapLeft"></div>
    <div class="map" id="mapRight"></div>
</div>
<div id="checkboxes">
    <button onclick="console.log(JSON.stringify(preservedFlightPath))"> log move path </button>  <button id="start"> start </button> <button id="stop"> stop </button> <br />
    <label><input id="show-tile-boundaries-checkbox" type="checkbox"> tile debug</label><br />
    <label><input id="show-symbol-collision-boxes-checkbox" type="checkbox"> collision debug</label><br />
    <label><input id="show-overdraw-checkbox" type="checkbox"> overdraw debug</label><br />

    <label><input id="symbol-avoid-edges" type="checkbox"> symbol-avoid-edges</label><br />
    <label><input id="text-allow-overlap" type="checkbox"> text-allow-overlap</label><br />
    <label><input id="text-ignore-placement" type="checkbox"> text-ignore-placement</label><br />
    <label class="orange"><input id="text-box-sizing" type="checkbox"> text-box-sizing: actual</label><br />
    <label class="orange"><input id="symbol-anchor-allowed-outside-tile" type="checkbox"> symbol-anchor-allowed-outside-tile</label><br />
    
    <div style="display: flex; align-items: center;">
        <label for="textmaxangle" style="padding-bottom: 2px; padding-right: 4px;">text-max-angle </label>
        <input type="range" id="textmaxangle" name="textmaxangle" value="55" min="0" max="360">
        <span id="textmaxangle">55</span>
    </div>
    <div style="display: flex; align-items: center;">
        <label for="symbolspacing" style="padding-bottom: 2px; padding-right: 4px;">symbol-spacing </label>
        <input type="range" id="symbolspacing" name="symbolspacing" value="250" min="1" max="300">
        <span id="symbolspacing">250</span>
    </div>
    <div style="display: flex; align-items: center;">
        <label class="orange" for="textboxscale" style="padding-bottom: 2px; padding-right: 4px;">text-box-scale </label>
        <input type="range" id="textboxscale" name="anchorboxscale" value="1.0" min="0.1" max="2.0" step="0.1">
        <span class="orange" id="textboxscale">1.0</span>
    </div>
</div>

<script src="../dist/maplibre-gl-dev.js"></script>
<script>

const targetMovePath = [[47.642712857044046, -122.34719033145636], [47.65857350247785, -122.34727041431958], [47.66941423275111, -122.34735049718458], [47.675130328103336, -122.3471102485924], [47.67971353714225, -122.34526834271873], [47.68548241614991, -122.34446751407893], [47.690927221326035, -122.34446751407955], [47.69631755755725, -122.34446751407881], [47.701815126501145, -122.34454759694248], [47.70720433722721, -122.34454759694307], [47.71259299078838, -122.3445475969429], [47.718196599460924, -122.34462767980759], [47.724015093722585, -122.34470776267132], [47.72929427614457, -122.34486792839863], [47.734680645429364, -122.34486792839904], [47.74033573358267, -122.34526834271946], [47.745720960793165, -122.34526834271946], [47.75126716240453, -122.3454285084475], [47.75665125872354, -122.34582892276762], [47.76203479796882, -122.3458289227675], [47.7675792610066, -122.34590900563103], [47.773123133069134, -122.34590900563103], [47.77850496772973, -122.34590900563134], [47.78329433208626, -122.34326627111818], [47.78840608810006, -122.33974262510095], [47.79346354135933, -122.33613889621967], [47.79959638811991, -122.33149409010505], [47.81234393704591, -122.32282019942642], [47.82094810830799, -122.31499689643107], [47.82110942290143, -122.3092309302204], [47.820894336665475, -122.30122264381662], [47.82094810830799, -122.2916127001327], [47.820894336665475, -122.28152225926473], [47.82073302140327, -122.27415463577296], [47.820786793212875, -122.2711114869397], [47.820464161519766, -122.26382394631312], [47.81890474673588, -122.2582181458306], [47.81594710728257, -122.25725715146216], [47.81196747199783, -122.2590990573351], [47.80852537930767, -122.26038038315968], [47.80874051678589, -122.26470485781786], [47.80986997391875, -122.27087123834835], [47.80728832152343, -122.27936002193616], [47.8051906344609, -122.2777583646554], [47.804437597928654, -122.2728733099492], [47.80072604409614, -122.27087123834772], [47.7957230954371, -122.27407455290921], [47.790343043244945, -122.27407455290954], [47.78404767508201, -122.27431480150159], [47.77904312055955, -122.27335380713296], [47.77592175661118, -122.27023057543545], [47.77166994220556, -122.26942974679551], [47.76822517942969, -122.26678701228207], [47.76628740009875, -122.26430444349714], [47.762088630546714, -122.26374386344868], [47.762088630546714, -122.26374386344868], [47.76009678801381, -122.26206212330398], [47.758427888257614, -122.26206212330398], [47.75788952207685, -122.26654676369037], [47.75514376790642, -122.27271314422117], [47.75336702623238, -122.27663720455891], [47.74981336088587, -122.28328408227378], [47.738336093393826, -122.29074277866857], [47.73300396489742, -122.29250460167722], [47.716465164879054, -122.29698924206203], [47.70322037917143, -122.30147388244752], [47.69780188823182, -122.30507761132971], [47.692303896103084, -122.30539794278545], [47.687991339778165, -122.31172448904465], [47.682878668166836, -122.3163692951581], [47.681530789078096, -122.3199675107794], [47.68007504054492, -122.32092850514783], [47.67473694838648, -122.32116875374024], [47.66993759128337, -122.32188949951649], [47.6645445286247, -122.32196958238013], [47.657694535808275, -122.32245007956452], [47.65267782926429, -122.32245007956453], [47.647606689859316, -122.32253016242859], [47.64275088219668, -122.32253016242879], [47.64231923300349, -122.31956709645948], [47.64296670545602, -122.31267997015243], [47.644207671892445, -122.30290986074004], [47.64517884245282, -122.29858538608212], [47.64480116715808, -122.29065718254233], [47.644261626286095, -122.28072690740258], [47.64318252782331, -122.27496094119155], [47.642046429472686, -122.26799373202118], [47.640771253312636, -122.25934478270574], [47.63973939945055, -122.25309831931094], [47.6381745639562, -122.24244729839405], [47.6363938320722, -122.235480089223], [47.63655571929658, -122.2253896483547], [47.64038690387713, -122.21810210772756], [47.64238332534018, -122.21105481569253], [47.64227541261707, -122.20296644642481], [47.64027898702972, -122.19720048021412], [47.637257224807286, -122.19391708278867], [47.633641672515154, -122.18935235953893], [47.63569231496976, -122.18694987361823], [47.63957752209021, -122.18654945929813], [47.64313870816105, -122.18678970789031], [47.64853398208689, -122.1869498736178], [47.653982643094025, -122.18694987361843], [47.65937679691231, -122.18694987361812], [47.66477039347794, -122.1869498736176], [47.670972340637405, -122.18694987361854], [47.67458530923648, -122.18486771915373], [47.68121742136964, -122.18382664192131], [47.6884562546914, -122.18190871160621], [47.69373903995296, -122.18054730291765], [47.69923688076824, -122.17990664000534], [47.707712758938555, -122.18118796582993], [47.71240087331148, -122.18391078320707], [47.718543281397245, -122.18775476068085], [47.72279943769951, -122.18911616936941], [47.73044886976248, -122.18855558932063], [47.73588897931728, -122.18767467781646], [47.74122081238761, -122.18687384917594], [47.74644440207666, -122.18703401490447], [47.75188284048829, -122.1865535177204], [47.75732071062026, -122.18479169471155], [47.758343612781914, -122.18399086607133], [47.759689506040104, -122.18423111466322], [47.764103791542055, -122.18631326912833], [47.76964803405551, -122.19007716373713], [47.77503022837331, -122.19087799237806], [47.78073474617403, -122.19400122407622], [47.78407106082474, -122.19604278097746], [47.788596281756725, -122.20228924437139], [47.79278365219457, -122.21077802795945], [47.797851378785964, -122.22022780591489], [47.80382233985233, -122.22687468363064], [47.80909342876109, -122.22919708668692], [47.81431488839746, -122.23360164420878], [47.82026157826206, -122.24297133930068], [47.82289116420972, -122.25057921138415], [47.827271992101515, -122.25586468041018], [47.83200310211342, -122.26288419614833], [47.83420722199767, -122.26416552197291], [47.83377715717657, -122.2627240304204], [47.832056862248805, -122.26256386469217], [47.830228986400556, -122.26456593629302], [47.82909997209626, -122.26584726211762], [47.82678810426694, -122.26816966517463], [47.825336413696334, -122.27105264827996], [47.82216405967196, -122.27721902881045], [47.820296474697614, -122.28066259196473], [47.81626297149373, -122.28778996686339], [47.8119606758824, -122.29619866758654], [47.807980735080605, -122.30364637394192], [47.80376556874816, -122.31066226548667], [47.79661084794611, -122.31514690587251], [47.79144609677451, -122.3163481488327], [47.78466658182904, -122.31650831456075], [47.778262894607224, -122.31778964038504], [47.772558105591514, -122.31979171198608], [47.76534549544729, -122.32315519227554], [47.75791653802415, -122.32771991552502], [47.75307099423583, -122.32996223571882], [47.74838653965128, -122.32868090989425], [47.74267847341213, -122.32940165566977], [47.737239073217864, -122.32635850683693], [47.73282250852455, -122.3246767666918], [47.72652017618532, -122.32419626950815], [47.7204864598246, -122.32395602091616], [47.71466757144907, -122.32643858970087], [47.708848033212234, -122.32980206999048], [47.7020577505653, -122.32980206999073], [47.69656020720737, -122.32956182139841], [47.69095427202282, -122.32900124134997], [47.68610249552887, -122.32571784392475], [47.682005088338286, -122.32131328640293], [47.676721114513015, -122.32051245776185], [47.671113046779936, -122.3219539493151], [47.665504376344984, -122.32235436363521], [47.66005691759523, -122.32235436363521], [47.654662834041886, -122.32235436363521], [47.64926819322673, -122.32235436363584], [47.64365717562623, -122.32291494368354], [47.638261397967455, -122.32291494368374], [47.63232539886991, -122.32435643523564], [47.6273062553868, -122.32820041270955], [47.62174685650649, -122.32852074416589], [47.616132882978576, -122.32916140707789], [47.61068027401919, -122.33116347867947], [47.60517310181754, -122.32852074416631]];

const degreesToRadians = (deg) => deg * Math.PI / 180.0;
const radiansToDegrees = (rad) => rad * 180.0 / Math.PI;
const bearing = (coordinates1, coordinates2) => {
    const lon1 = degreesToRadians(coordinates1[0]);
    const lon2 = degreesToRadians(coordinates2[0]);
    const lat1 = degreesToRadians(coordinates1[1]);
    const lat2 = degreesToRadians(coordinates2[1]);
    const a = Math.sin(lon2 - lon1) * Math.cos(lat2);
    const b =
    Math.cos(lat1) * Math.sin(lat2) -
    Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);

    return radiansToDegrees(Math.atan2(a, b));
};

const mapLeft = window.mapLeft = new maplibregl.Map({
    container: 'mapLeft',
    zoom: 13.1,
    center: [-122.34687, 47.63586],
    style: 'http://localhost:9966/debug/bing_style.json',
    hash: true
});

const mapRight = window.mapRight = new maplibregl.Map({
    container: 'mapRight',
    zoom: 13.1,
    center: [-122.34687, 47.63586],
    style: 'http://localhost:9966/debug/bing_naked_style.json',
    hash: true
});

const preservedFlightPath = window.preservedFlightPath = [];
let flying = false;

const maps = [mapLeft, mapRight];
let moveLockIdx = -1;
maps.forEach((map, mapIdx) => {
    map.addControl(new maplibregl.NavigationControl(), 'top-left');
    map.addControl(new maplibregl.ScaleControl());

    map.on('load', function() {
        document.querySelector('input#textmaxangle').addEventListener('input', function() {
            document.querySelector('span#textmaxangle').firstChild.textContent = this.value;
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'text-max-angle', parseInt(this.value));
            });
        });

        document.querySelector('input#symbolspacing').addEventListener('input', function() {
            document.querySelector('span#symbolspacing').firstChild.textContent = this.value;
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'symbol-spacing', parseInt(this.value));
            });
        });

        document.querySelector('input#textboxscale').addEventListener('input', function() {
            document.querySelector('span#textboxscale').firstChild.textContent = this.value;
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'text-box-scale', parseFloat(this.value));
            });
        });

        document.getElementById('symbol-avoid-edges').addEventListener('click', function() {
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'symbol-avoid-edges', !!this.checked);
            });
        });

        document.getElementById('text-allow-overlap').addEventListener('click', function() {
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'text-allow-overlap', !!this.checked);
            });
        });

        document.getElementById('text-ignore-placement').addEventListener('click', function() {
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'text-ignore-placement', !!this.checked);
            });
        });

        document.getElementById('text-box-sizing').addEventListener('click', function() {
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'text-box-sizing', this.checked ? 'actual' : 'max');
            });
        });

        document.getElementById('symbol-anchor-allowed-outside-tile').addEventListener('click', function() {
            map.getStyle().layers.filter(layer => layer.type === 'symbol' && layer.source === 'bing-mvt').forEach(layer => {
                map.setLayoutProperty(layer.id, 'symbol-anchor-allowed-outside-tile', !!this.checked);
            });
        });
    });

    map.on('move', (event) => {
        if (moveLockIdx !== mapIdx && moveLockIdx !== -1) {
            return;
        }

        moveLockIdx = mapIdx;
        if (mapIdx === 0) {
            mapRight.setCenter(map.getCenter());
            mapRight.setBearing(map.getBearing());
            mapRight.setPitch(map.getPitch());
            mapRight.setZoom(map.getZoom());
        } else {
            mapLeft.setCenter(map.getCenter());
            mapLeft.setBearing(map.getBearing());
            mapLeft.setPitch(map.getPitch());
            mapLeft.setZoom(map.getZoom());
        }

        moveLockIdx = -1;
    });

    map.on('flystart', function() {
        flying = true;
    });
    map.on('flyend', function() {
        flying = false;
    });

    // preserve clicks to then animate the flight path based on desired path
    map.on('click', (event) => {
        const element = [event.lngLat.lat, event.lngLat.lng];
        console.log(`Recorder: ${element}`);
        preservedFlightPath.push(element);
    });

    document.getElementById('show-tile-boundaries-checkbox').addEventListener('click', function() {
        map.showTileBoundaries = !!this.checked;
    });

    document.getElementById('show-symbol-collision-boxes-checkbox').addEventListener('click', function() {
        map.showCollisionBoxes = !!this.checked;
    });

    document.getElementById('show-overdraw-checkbox').addEventListener('click', function() {
        map.showOverdrawInspector = !!this.checked;
    });

    if (mapIdx == 0) {
        let movePath = [...targetMovePath];
        document.getElementById('start').onclick = event => {
            movePath = [...targetMovePath];
            startFlightSequence(map, movePath, 0);
        };
        document.getElementById('stop').onclick = event => {
            map.stop();
            movePath.length = 0;
        };
    }
});

function startFlightSequence(map, movePath, idx) {
    if (flying) {
        requestAnimationFrame(() => startFlightSequence(map, movePath, idx));
        return;
    }

    if (idx + 1 >= movePath.length) {
        return;
    }

    const [lat, lng] = movePath[idx];
    const [nlat, nlng] = movePath[idx + 1];

    const b = bearing([lng, lat], [nlng, nlat]);
    map.easeTo({
        center: [lng, lat],
        zoom: 13,
        bearing: b,
        speed: 0.2,
        curve: 1,
        duration: 2000,
        easing: t => t
    });

    setTimeout(() => startFlightSequence(map, movePath, idx + 1), 2000);
}

</script>
</body>
</html>
